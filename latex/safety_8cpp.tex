\hypertarget{safety_8cpp}{}\doxysection{Math/math\+\_\+pkg/src/safety.cpp File Reference}
\label{safety_8cpp}\index{Math/math\_pkg/src/safety.cpp@{Math/math\_pkg/src/safety.cpp}}
{\ttfamily \#include $<$algorithm$>$}\newline
{\ttfamily \#include \char`\"{}math\+\_\+pkg/\+Safety.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}ros/ros.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}sensor\+\_\+msgs/\+Joint\+State.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}std\+\_\+msgs/\+Float64\+Multi\+Array.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}utilities.\+h\char`\"{}}\newline
\doxysubsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \mbox{\hyperlink{safety_8cpp_a9167635e8077f602a0c8e28c542613b2}{C\+O\+R\+R\+P\+O\+L\+E\+\_\+\+P\+OS}}~70
\item 
\#define \mbox{\hyperlink{safety_8cpp_a646a293c3dcd0e785b7b2c55c3c2bf79}{C\+O\+R\+R\+P\+O\+L\+E\+\_\+\+V\+EL}}~8
\item 
\#define \mbox{\hyperlink{safety_8cpp_a356e9371247711c51b3b4fed9c8a9965}{J\+O\+I\+N\+T\+S\+\_\+\+M\+A\+R\+G\+IN}}~0.\+1
\item 
\#define \mbox{\hyperlink{safety_8cpp_a241b5a3d3b70356d48cd60e331ec48cc}{V\+E\+L\+\_\+\+M\+A\+R\+G\+IN}}~0.\+01
\end{DoxyCompactItemize}
\doxysubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \mbox{\hyperlink{safety_8cpp_ae822dff1c16307a14b3ba1d6da21ae95}{safety\+Callbackq}} (const sensor\+\_\+msgs\+::\+Joint\+State \&msg)
\item 
void \mbox{\hyperlink{safety_8cpp_a82ba145e1df3611122ac365407d89b80}{safety\+Callbackqdot}} (const sensor\+\_\+msgs\+::\+Joint\+State \&msg)
\item 
double \mbox{\hyperlink{safety_8cpp_a3f08762e7965b0ad6b99982b40cb97b3}{cos\+\_\+sigmoid}} (double x, double y, double mrgn)
\item 
bool \mbox{\hyperlink{safety_8cpp_ac171fa2e87bc8f6774f69324650bd3d1}{joint\+Constr}} (double x, const double xmin, const double xmax, const double mrgn, const double c\+Pole, double \&current\+Pole, const bool is\+Joint, double \&rdot, double \&Adiag)
\item 
void \mbox{\hyperlink{safety_8cpp_a31f04ff12424a4ecbdd03e42bdd37ccf}{safety\+Loop}} (Vector\+Xd \&rdot, Vector\+Xd \&Adiag)
\item 
bool \mbox{\hyperlink{safety_8cpp_ac0c5b59b06e31ad50542ecdd259b7c2d}{compute\+Partialqdot}} (math\+\_\+pkg\+::\+Safety\+::\+Request \&req, math\+\_\+pkg\+::\+Safety\+::\+Response \&res)
\item 
int \mbox{\hyperlink{safety_8cpp_a3c04138a5bfe5d72780bb7e82a18e627}{main}} (int argc, char $\ast$$\ast$argv)
\end{DoxyCompactItemize}
\doxysubsection*{Variables}
\begin{DoxyCompactItemize}
\item 
bool \mbox{\hyperlink{safety_8cpp_a36f414f3027e17561da1cc980cc683f7}{readyq}}
\item 
bool \mbox{\hyperlink{safety_8cpp_a264031af035928b59314f611ace3c38d}{readyqdot}}
\item 
double \mbox{\hyperlink{safety_8cpp_aa7a3c54f6ce8de220877d3ecd2a860c7}{current\+Angle\+Pole}} \mbox{[}\mbox{\hyperlink{utilities_8h_a02e7d9123cf9196d84fc399cf563e378}{N\+J\+O\+I\+N\+TS}}\mbox{]}
\item 
double \mbox{\hyperlink{safety_8cpp_a209f415afdd52b0876ae3cb46e04f9b2}{current\+Vel\+Pole}} \mbox{[}\mbox{\hyperlink{utilities_8h_a02e7d9123cf9196d84fc399cf563e378}{N\+J\+O\+I\+N\+TS}}\mbox{]}
\item 
double \mbox{\hyperlink{safety_8cpp_a9cdf00135d8fde1d601bb55fec55a2e6}{q}} \mbox{[}\mbox{\hyperlink{utilities_8h_a02e7d9123cf9196d84fc399cf563e378}{N\+J\+O\+I\+N\+TS}}\mbox{]}
\item 
double \mbox{\hyperlink{safety_8cpp_a317c43362faf4475dce4577384fa9578}{qdot}} \mbox{[}\mbox{\hyperlink{utilities_8h_a02e7d9123cf9196d84fc399cf563e378}{N\+J\+O\+I\+N\+TS}}\mbox{]}
\item 
int \mbox{\hyperlink{safety_8cpp_ac9950c5982e6fa3841bc2b31e3a317b9}{seqtry}}
\item 
int \mbox{\hyperlink{safety_8cpp_a4ceb5170a23ad09b5f7571491ccf9da6}{seqqdot}}
\end{DoxyCompactItemize}


\doxysubsection{Macro Definition Documentation}
\mbox{\Hypertarget{safety_8cpp_a9167635e8077f602a0c8e28c542613b2}\label{safety_8cpp_a9167635e8077f602a0c8e28c542613b2}} 
\index{safety.cpp@{safety.cpp}!CORRPOLE\_POS@{CORRPOLE\_POS}}
\index{CORRPOLE\_POS@{CORRPOLE\_POS}!safety.cpp@{safety.cpp}}
\doxysubsubsection{\texorpdfstring{CORRPOLE\_POS}{CORRPOLE\_POS}}
{\footnotesize\ttfamily \#define C\+O\+R\+R\+P\+O\+L\+E\+\_\+\+P\+OS~70}

Abs value of the position correction pole for safety task. 

Definition at line 23 of file safety.\+cpp.

\mbox{\Hypertarget{safety_8cpp_a646a293c3dcd0e785b7b2c55c3c2bf79}\label{safety_8cpp_a646a293c3dcd0e785b7b2c55c3c2bf79}} 
\index{safety.cpp@{safety.cpp}!CORRPOLE\_VEL@{CORRPOLE\_VEL}}
\index{CORRPOLE\_VEL@{CORRPOLE\_VEL}!safety.cpp@{safety.cpp}}
\doxysubsubsection{\texorpdfstring{CORRPOLE\_VEL}{CORRPOLE\_VEL}}
{\footnotesize\ttfamily \#define C\+O\+R\+R\+P\+O\+L\+E\+\_\+\+V\+EL~8}

Abs value of the velocity correction pole for safety task. 

Definition at line 25 of file safety.\+cpp.

\mbox{\Hypertarget{safety_8cpp_a356e9371247711c51b3b4fed9c8a9965}\label{safety_8cpp_a356e9371247711c51b3b4fed9c8a9965}} 
\index{safety.cpp@{safety.cpp}!JOINTS\_MARGIN@{JOINTS\_MARGIN}}
\index{JOINTS\_MARGIN@{JOINTS\_MARGIN}!safety.cpp@{safety.cpp}}
\doxysubsubsection{\texorpdfstring{JOINTS\_MARGIN}{JOINTS\_MARGIN}}
{\footnotesize\ttfamily \#define J\+O\+I\+N\+T\+S\+\_\+\+M\+A\+R\+G\+IN~0.\+1}

Soft margin of joint angles. 

Definition at line 27 of file safety.\+cpp.

\mbox{\Hypertarget{safety_8cpp_a241b5a3d3b70356d48cd60e331ec48cc}\label{safety_8cpp_a241b5a3d3b70356d48cd60e331ec48cc}} 
\index{safety.cpp@{safety.cpp}!VEL\_MARGIN@{VEL\_MARGIN}}
\index{VEL\_MARGIN@{VEL\_MARGIN}!safety.cpp@{safety.cpp}}
\doxysubsubsection{\texorpdfstring{VEL\_MARGIN}{VEL\_MARGIN}}
{\footnotesize\ttfamily \#define V\+E\+L\+\_\+\+M\+A\+R\+G\+IN~0.\+01}

Soft margin of joint velocities. 

Definition at line 29 of file safety.\+cpp.



\doxysubsection{Function Documentation}
\mbox{\Hypertarget{safety_8cpp_ac0c5b59b06e31ad50542ecdd259b7c2d}\label{safety_8cpp_ac0c5b59b06e31ad50542ecdd259b7c2d}} 
\index{safety.cpp@{safety.cpp}!computePartialqdot@{computePartialqdot}}
\index{computePartialqdot@{computePartialqdot}!safety.cpp@{safety.cpp}}
\doxysubsubsection{\texorpdfstring{computePartialqdot()}{computePartialqdot()}}
{\footnotesize\ttfamily bool compute\+Partialqdot (\begin{DoxyParamCaption}\item[{math\+\_\+pkg\+::\+Safety\+::\+Request \&}]{req,  }\item[{math\+\_\+pkg\+::\+Safety\+::\+Response \&}]{res }\end{DoxyParamCaption})}

Service function for the Safety service, which computes the partial joint velocities based on the safety task. 
\begin{DoxyParams}{Parameters}
{\em req} & Server request object. \\
\hline
{\em res} & Server response object. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
true if client-\/service call succeeded, false otherwise. 
\end{DoxyReturn}


Definition at line 149 of file safety.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{149                                                                                   \{}
\DoxyCodeLine{150     \textcolor{keywordflow}{if} (!(\mbox{\hyperlink{safety_8cpp_a36f414f3027e17561da1cc980cc683f7}{readyq}} \&\& \mbox{\hyperlink{safety_8cpp_a264031af035928b59314f611ace3c38d}{readyqdot}})||(\mbox{\hyperlink{safety_8cpp_ac9950c5982e6fa3841bc2b31e3a317b9}{seqtry}} != \mbox{\hyperlink{safety_8cpp_a4ceb5170a23ad09b5f7571491ccf9da6}{seqqdot}})) \{ \textcolor{comment}{// at least one subscribtion data is missing}}
\DoxyCodeLine{151         \mbox{\hyperlink{safety_8cpp_a36f414f3027e17561da1cc980cc683f7}{readyq}} = \mbox{\hyperlink{safety_8cpp_a264031af035928b59314f611ace3c38d}{readyqdot}} = \textcolor{keyword}{false}; \textcolor{comment}{// reset availability flag}}
\DoxyCodeLine{152         ROS\_ERROR(\textcolor{stringliteral}{"{}safety service could not run: missing data."{}});}
\DoxyCodeLine{153         \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{154     \}}
\DoxyCodeLine{155 }
\DoxyCodeLine{156     \mbox{\hyperlink{safety_8cpp_a36f414f3027e17561da1cc980cc683f7}{readyq}} = \mbox{\hyperlink{safety_8cpp_a264031af035928b59314f611ace3c38d}{readyqdot}} = \textcolor{keyword}{false}; \textcolor{comment}{// reset availability flag}}
\DoxyCodeLine{157     VectorXd partial\_qdot(\mbox{\hyperlink{utilities_8h_a02e7d9123cf9196d84fc399cf563e378}{NJOINTS}}),rdot(\mbox{\hyperlink{utilities_8h_a02e7d9123cf9196d84fc399cf563e378}{NJOINTS}}),Adiag(\mbox{\hyperlink{utilities_8h_a02e7d9123cf9196d84fc399cf563e378}{NJOINTS}});}
\DoxyCodeLine{158 }
\DoxyCodeLine{159     \textcolor{comment}{// Obtain the derivative of the task vector and the activation values, stored in 1D vectors.}}
\DoxyCodeLine{160     \mbox{\hyperlink{safety_8cpp_a31f04ff12424a4ecbdd03e42bdd37ccf}{safetyLoop}}(rdot,Adiag);}
\DoxyCodeLine{161     MatrixXd A = Adiag.asDiagonal(); \textcolor{comment}{// store the diagonal of A into a sparse matrix structure (needed for the following computations)}}
\DoxyCodeLine{162 }
\DoxyCodeLine{163     \textcolor{comment}{// For the safety task, the Jacobian is the identity and Q is the zero matrix.}}
\DoxyCodeLine{164     \textcolor{keywordtype}{double} cond;}
\DoxyCodeLine{165     MatrixXd pinvJ = \mbox{\hyperlink{utilities_8h_a66dede39bc52472042a84f87099ec816}{regPinv}}(\mbox{\hyperlink{utilities_8h_af89a8758592469410415b30b4c8accda}{ID\_MATRIX\_NJ}},A,\mbox{\hyperlink{utilities_8h_af89a8758592469410415b30b4c8accda}{ID\_MATRIX\_NJ}},\mbox{\hyperlink{utilities_8h_af77edc1f833593caecfc032dcc5953a6}{ETA}},cond);}
\DoxyCodeLine{166     MatrixXd Q1 = \mbox{\hyperlink{utilities_8h_af89a8758592469410415b30b4c8accda}{ID\_MATRIX\_NJ}} -\/ pinvJ; \textcolor{comment}{// Q1 will be needed for the tracking task.}}
\DoxyCodeLine{167     partial\_qdot = pinvJ * pinvJ * rdot;}
\DoxyCodeLine{168 }
\DoxyCodeLine{169     \textcolor{comment}{// Store Q2 into a 1D vector so that it can be sent to the client in a Float64MultiArray object.}}
\DoxyCodeLine{170     Map<MatrixXd> Q1v (Q1.data(), \mbox{\hyperlink{utilities_8h_a02e7d9123cf9196d84fc399cf563e378}{NJOINTS}}*\mbox{\hyperlink{utilities_8h_a02e7d9123cf9196d84fc399cf563e378}{NJOINTS}},1);}
\DoxyCodeLine{171 }
\DoxyCodeLine{172     \textcolor{comment}{// Fill response object.}}
\DoxyCodeLine{173     res.qdot.velocity = vector<double> (partial\_qdot.data(), partial\_qdot.data() + partial\_qdot.size());}
\DoxyCodeLine{174     res.Q1.data = vector<double> (Q1v.data(), Q1v.data() + Q1v.size());}
\DoxyCodeLine{175 }
\DoxyCodeLine{176     \textcolor{keywordflow}{return} \textcolor{keyword}{true}; \textcolor{comment}{// request successful}}
\DoxyCodeLine{177 \}}

\end{DoxyCode}
\mbox{\Hypertarget{safety_8cpp_a3f08762e7965b0ad6b99982b40cb97b3}\label{safety_8cpp_a3f08762e7965b0ad6b99982b40cb97b3}} 
\index{safety.cpp@{safety.cpp}!cos\_sigmoid@{cos\_sigmoid}}
\index{cos\_sigmoid@{cos\_sigmoid}!safety.cpp@{safety.cpp}}
\doxysubsubsection{\texorpdfstring{cos\_sigmoid()}{cos\_sigmoid()}}
{\footnotesize\ttfamily double cos\+\_\+sigmoid (\begin{DoxyParamCaption}\item[{double}]{x,  }\item[{double}]{y,  }\item[{double}]{mrgn }\end{DoxyParamCaption})}

Cosinoidal sigmoid function departing from zero at y+/-\/mrgn and gets to 1 at y, with period 2$\ast$mrgn. 
\begin{DoxyParams}{Parameters}
{\em x} & Point at which the sigmoid is evaluated. \\
\hline
{\em y} & Point at which the sigmoid gets to 1. \\
\hline
{\em mrgn} & Half the sigmoid\textquotesingle{}s period. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
the sigmoid value at x. 
\end{DoxyReturn}


Definition at line 69 of file safety.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{69                                                          \{}
\DoxyCodeLine{70     \textcolor{keywordflow}{return} (.5 + .5 * cos((x -\/ y) * M\_PI/mrgn));}
\DoxyCodeLine{71 \}}

\end{DoxyCode}
\mbox{\Hypertarget{safety_8cpp_ac171fa2e87bc8f6774f69324650bd3d1}\label{safety_8cpp_ac171fa2e87bc8f6774f69324650bd3d1}} 
\index{safety.cpp@{safety.cpp}!jointConstr@{jointConstr}}
\index{jointConstr@{jointConstr}!safety.cpp@{safety.cpp}}
\doxysubsubsection{\texorpdfstring{jointConstr()}{jointConstr()}}
{\footnotesize\ttfamily bool joint\+Constr (\begin{DoxyParamCaption}\item[{double}]{x,  }\item[{const double}]{xmin,  }\item[{const double}]{xmax,  }\item[{const double}]{mrgn,  }\item[{const double}]{c\+Pole,  }\item[{double \&}]{current\+Pole,  }\item[{const bool}]{is\+Joint,  }\item[{double \&}]{rdot,  }\item[{double \&}]{Adiag }\end{DoxyParamCaption})}

Function that evaluates task element derivative and activation value for quantity x. 
\begin{DoxyParams}{Parameters}
{\em x} & Scalar quantity. \\
\hline
{\em xmin} & Min value of x. \\
\hline
{\em xmax} & Max value of x. \\
\hline
{\em mrgn} & Soft margin of x. \\
\hline
{\em c\+Pole} & Absolute value of correction pole. \\
\hline
{\em current\+Pole} & Current correction pole for x, if any, 0 otherwise. \\
\hline
{\em is\+Joint} & True if x is a joint angle, false otherwise. \\
\hline
{\em rdot} & Reference to task reference derivative for quantity x. \\
\hline
{\em Adiag} & Reference to activation value for quantity x. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
true if no correction needed to behaviour of x, false otherwise. 
\end{DoxyReturn}


Definition at line 87 of file safety.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{89                                                                         \{}
\DoxyCodeLine{90     \textcolor{keywordtype}{bool} ok = \textcolor{keyword}{false};}
\DoxyCodeLine{91 }
\DoxyCodeLine{92     \textcolor{keywordflow}{if} (x > xmax -\/ mrgn) \{ \textcolor{comment}{// x too high}}
\DoxyCodeLine{93         \textcolor{comment}{//cout << "{}too high"{} << x << "{}>"{} << xmax -\/ mrgn << "{}, is joint = "{} << isJoint << endl;}}
\DoxyCodeLine{94         \textcolor{keywordflow}{if} (currentPole == 0) currentPole = cPole; \textcolor{comment}{// if the task has just been activated, assign pole for the task}}
\DoxyCodeLine{95         \textcolor{keywordflow}{if} (isJoint) rdot = currentPole * (-\/x + xmax -\/ mrgn);}
\DoxyCodeLine{96         \textcolor{keywordflow}{else} rdot = currentPole * (-\/x + xmax -\/ mrgn) * \mbox{\hyperlink{utilities_8h_a943f07034774ef1261d62cd0d3d1fec9}{DT}} + x;}
\DoxyCodeLine{97         \textcolor{keywordflow}{if} (x > xmax) Adiag = 1; \textcolor{comment}{// x over the limit, task activation value = 1 (full activation)}}
\DoxyCodeLine{98         \textcolor{keywordflow}{else} Adiag = \mbox{\hyperlink{safety_8cpp_a3f08762e7965b0ad6b99982b40cb97b3}{cos\_sigmoid}}(x,xmax,mrgn); \textcolor{comment}{// task activation value is between 0 and 1}}
\DoxyCodeLine{99     \}}
\DoxyCodeLine{100     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (x < xmin + mrgn) \{ \textcolor{comment}{// x too low}}
\DoxyCodeLine{101         \textcolor{comment}{//cout << "{}too low"{} << x << "{}<"{} << xmin + mrgn << "{}, is joint = "{} << isJoint << endl;}}
\DoxyCodeLine{102         \textcolor{keywordflow}{if} (currentPole == 0) currentPole = cPole; \textcolor{comment}{// if the task has just been activated, assign pole for the task}}
\DoxyCodeLine{103         \textcolor{keywordflow}{if} (isJoint) rdot = currentPole * (-\/x + xmin + mrgn);}
\DoxyCodeLine{104         \textcolor{keywordflow}{else} rdot = currentPole * (-\/x + xmin + mrgn) * \mbox{\hyperlink{utilities_8h_a943f07034774ef1261d62cd0d3d1fec9}{DT}} + x;}
\DoxyCodeLine{105         \textcolor{keywordflow}{if} (x < xmin) Adiag = 1; \textcolor{comment}{// x under the limit, task activation value = 1 (full activation)}}
\DoxyCodeLine{106         \textcolor{keywordflow}{else} Adiag = \mbox{\hyperlink{safety_8cpp_a3f08762e7965b0ad6b99982b40cb97b3}{cos\_sigmoid}}(x,xmin,mrgn); \textcolor{comment}{// task activation value is between 0 and 1}}
\DoxyCodeLine{107     \}}
\DoxyCodeLine{108     \textcolor{keywordflow}{else} \{ \textcolor{comment}{// x has a safe value}}
\DoxyCodeLine{109         Adiag = 0; rdot = 0;\textcolor{comment}{// task inactive}}
\DoxyCodeLine{110         ok = \textcolor{keyword}{true};}
\DoxyCodeLine{111         currentPole = 0; \textcolor{comment}{// task is inactive, thus no pole is necessary}}
\DoxyCodeLine{112     \}}
\DoxyCodeLine{113     \textcolor{keywordflow}{return} ok;}
\DoxyCodeLine{114 \}}

\end{DoxyCode}
\mbox{\Hypertarget{safety_8cpp_a3c04138a5bfe5d72780bb7e82a18e627}\label{safety_8cpp_a3c04138a5bfe5d72780bb7e82a18e627}} 
\index{safety.cpp@{safety.cpp}!main@{main}}
\index{main@{main}!safety.cpp@{safety.cpp}}
\doxysubsubsection{\texorpdfstring{main()}{main()}}
{\footnotesize\ttfamily int main (\begin{DoxyParamCaption}\item[{int}]{argc,  }\item[{char $\ast$$\ast$}]{argv }\end{DoxyParamCaption})}

Main function of the node. 

Definition at line 183 of file safety.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{183                                \{}
\DoxyCodeLine{184 }
\DoxyCodeLine{185     ros::init(argc, argv, \textcolor{stringliteral}{"{}safety\_server"{}}); \textcolor{comment}{// initialize node}}
\DoxyCodeLine{186     ros::NodeHandle n; \textcolor{comment}{// define node handle}}
\DoxyCodeLine{187     \textcolor{keywordtype}{int} queSize = 10;}
\DoxyCodeLine{188     }
\DoxyCodeLine{189     ros::Subscriber sub1 = n.subscribe(\textcolor{stringliteral}{"{}logtopic"{}}, queSize, \mbox{\hyperlink{safety_8cpp_ae822dff1c16307a14b3ba1d6da21ae95}{safetyCallbackq}}); \textcolor{comment}{// subscribe to integrator}}
\DoxyCodeLine{190     ros::Subscriber sub2 = n.subscribe(\textcolor{stringliteral}{"{}cmdtopic"{}}, queSize, \mbox{\hyperlink{safety_8cpp_a82ba145e1df3611122ac365407d89b80}{safetyCallbackqdot}}); \textcolor{comment}{// subscribe to weighter}}
\DoxyCodeLine{191     }
\DoxyCodeLine{192     ros::ServiceServer service = n.advertiseService(\textcolor{stringliteral}{"{}safety"{}}, \mbox{\hyperlink{safety_8cpp_ac0c5b59b06e31ad50542ecdd259b7c2d}{computePartialqdot}}); \textcolor{comment}{// activate safety service}}
\DoxyCodeLine{193 }
\DoxyCodeLine{194     ros::spin(); \textcolor{comment}{// keep node alive}}
\DoxyCodeLine{195     \textcolor{keywordflow}{return} 0;}
\DoxyCodeLine{196 \}}

\end{DoxyCode}
\mbox{\Hypertarget{safety_8cpp_ae822dff1c16307a14b3ba1d6da21ae95}\label{safety_8cpp_ae822dff1c16307a14b3ba1d6da21ae95}} 
\index{safety.cpp@{safety.cpp}!safetyCallbackq@{safetyCallbackq}}
\index{safetyCallbackq@{safetyCallbackq}!safety.cpp@{safety.cpp}}
\doxysubsubsection{\texorpdfstring{safetyCallbackq()}{safetyCallbackq()}}
{\footnotesize\ttfamily void safety\+Callbackq (\begin{DoxyParamCaption}\item[{const sensor\+\_\+msgs\+::\+Joint\+State \&}]{msg }\end{DoxyParamCaption})}

Callback function for joint angles. 
\begin{DoxyParams}{Parameters}
{\em msg} & The received joint angles vector. \\
\hline
\end{DoxyParams}


Definition at line 38 of file safety.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{38                                                        \{}
\DoxyCodeLine{39     \mbox{\hyperlink{safety_8cpp_ac9950c5982e6fa3841bc2b31e3a317b9}{seqtry}} = (int)msg.effort[0]; \textcolor{comment}{// q sequence number}}
\DoxyCodeLine{40     \mbox{\hyperlink{launcher_8sh_aecf1c3c6d4c86f147f4617c1f42525f0}{if}} (\mbox{\hyperlink{safety_8cpp_ac9950c5982e6fa3841bc2b31e3a317b9}{seqtry}} < \mbox{\hyperlink{safety_8cpp_a4ceb5170a23ad09b5f7571491ccf9da6}{seqqdot}}) \textcolor{keywordflow}{return}; \textcolor{comment}{// the received q is old, nothing to do with it}}
\DoxyCodeLine{41 }
\DoxyCodeLine{42     \textcolor{comment}{// At this point, the received q is up to date: store it in global variable q.}}
\DoxyCodeLine{43     vector<double> rcvd\_q = msg.position; \textcolor{comment}{// should look at the position field, but Coppelia has a problem with it...}}
\DoxyCodeLine{44     std::copy(rcvd\_q.begin(), rcvd\_q.end(), \mbox{\hyperlink{safety_8cpp_a9cdf00135d8fde1d601bb55fec55a2e6}{q}});}
\DoxyCodeLine{45     \mbox{\hyperlink{safety_8cpp_a36f414f3027e17561da1cc980cc683f7}{readyq}} = \textcolor{keyword}{true}; \textcolor{comment}{// q available, thus set flag to true}}
\DoxyCodeLine{46 \}}

\end{DoxyCode}
\mbox{\Hypertarget{safety_8cpp_a82ba145e1df3611122ac365407d89b80}\label{safety_8cpp_a82ba145e1df3611122ac365407d89b80}} 
\index{safety.cpp@{safety.cpp}!safetyCallbackqdot@{safetyCallbackqdot}}
\index{safetyCallbackqdot@{safetyCallbackqdot}!safety.cpp@{safety.cpp}}
\doxysubsubsection{\texorpdfstring{safetyCallbackqdot()}{safetyCallbackqdot()}}
{\footnotesize\ttfamily void safety\+Callbackqdot (\begin{DoxyParamCaption}\item[{const sensor\+\_\+msgs\+::\+Joint\+State \&}]{msg }\end{DoxyParamCaption})}

Callback function for joint velocities. 
\begin{DoxyParams}{Parameters}
{\em msg} & The received joint velocities vector. \\
\hline
\end{DoxyParams}


Definition at line 53 of file safety.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{53                                                           \{}
\DoxyCodeLine{54     \textcolor{comment}{// Store data in global variable qdot.}}
\DoxyCodeLine{55     vector<double> rcvd\_qdot = msg.velocity;}
\DoxyCodeLine{56     std::copy(rcvd\_qdot.begin(), rcvd\_qdot.end(), \mbox{\hyperlink{safety_8cpp_a317c43362faf4475dce4577384fa9578}{qdot}});}
\DoxyCodeLine{57 }
\DoxyCodeLine{58     \mbox{\hyperlink{safety_8cpp_a4ceb5170a23ad09b5f7571491ccf9da6}{seqqdot}} = (int)msg.effort[0]; \textcolor{comment}{// update sequence number}}
\DoxyCodeLine{59     \mbox{\hyperlink{safety_8cpp_a264031af035928b59314f611ace3c38d}{readyqdot}} = \textcolor{keyword}{true}; \textcolor{comment}{// qdot available, thus set flag to true}}
\DoxyCodeLine{60 \}}

\end{DoxyCode}
\mbox{\Hypertarget{safety_8cpp_a31f04ff12424a4ecbdd03e42bdd37ccf}\label{safety_8cpp_a31f04ff12424a4ecbdd03e42bdd37ccf}} 
\index{safety.cpp@{safety.cpp}!safetyLoop@{safetyLoop}}
\index{safetyLoop@{safetyLoop}!safety.cpp@{safety.cpp}}
\doxysubsubsection{\texorpdfstring{safetyLoop()}{safetyLoop()}}
{\footnotesize\ttfamily void safety\+Loop (\begin{DoxyParamCaption}\item[{Vector\+Xd \&}]{rdot,  }\item[{Vector\+Xd \&}]{Adiag }\end{DoxyParamCaption})}

Function that computes the derivative of the task vector and the diagonal of the activation matrix 
\begin{DoxyParams}{Parameters}
{\em rdot} & Vector passed by reference; on return it will contain the derivative of the task vector. \\
\hline
{\em Adiag} & Vector passed by reference; on return it will contain the elements of the diagonal of the activation matrix A. \\
\hline
\end{DoxyParams}


Definition at line 123 of file safety.\+cpp.


\begin{DoxyCode}{0}
\DoxyCodeLine{123                                                  \{}
\DoxyCodeLine{124     \textcolor{keywordtype}{bool} angleOk;}
\DoxyCodeLine{125     \textcolor{keywordtype}{double} rdot\_i,Adiag\_i;}
\DoxyCodeLine{126     \textcolor{keywordflow}{for}(\textcolor{keywordtype}{short} i = 0; i<\mbox{\hyperlink{utilities_8h_a02e7d9123cf9196d84fc399cf563e378}{NJOINTS}}; i++) \{ \textcolor{comment}{// for all joints}}
\DoxyCodeLine{127         \textcolor{comment}{// Compute and store the i-\/th element of rdot and of the diagonal of A, based on the angle constraint task.}}
\DoxyCodeLine{128         angleOk = \mbox{\hyperlink{safety_8cpp_ac171fa2e87bc8f6774f69324650bd3d1}{jointConstr}}(\mbox{\hyperlink{safety_8cpp_a9cdf00135d8fde1d601bb55fec55a2e6}{q}}[i],\mbox{\hyperlink{utilities_8h_ab092fe4291fb68da50654476ea0b7bd3}{QMIN}}[i],\mbox{\hyperlink{utilities_8h_a857331cbe5e4e72a02853ab15cd54a09}{QMAX}}[i],\mbox{\hyperlink{safety_8cpp_a356e9371247711c51b3b4fed9c8a9965}{JOINTS\_MARGIN}},\mbox{\hyperlink{safety_8cpp_a9167635e8077f602a0c8e28c542613b2}{CORRPOLE\_POS}},\mbox{\hyperlink{safety_8cpp_aa7a3c54f6ce8de220877d3ecd2a860c7}{currentAnglePole}}[i],\textcolor{keyword}{true},rdot\_i,Adiag\_i);}
\DoxyCodeLine{129 }
\DoxyCodeLine{130         \textcolor{comment}{// If joint i has a safe rotation angle, check for the safety of its velocity. Otherwise, the angle correction task will automatically bring the joint velocity to 0.}}
\DoxyCodeLine{131         \textcolor{keywordflow}{if} (angleOk) \{}
\DoxyCodeLine{132 }
\DoxyCodeLine{133             \textcolor{comment}{// Compute and store the i-\/th element of rdot and of the diagonal of A, based on the velocity constraint task.}}
\DoxyCodeLine{134             \mbox{\hyperlink{safety_8cpp_ac171fa2e87bc8f6774f69324650bd3d1}{jointConstr}}(\mbox{\hyperlink{safety_8cpp_a317c43362faf4475dce4577384fa9578}{qdot}}[i],-\/\mbox{\hyperlink{utilities_8h_a7793a0ce6c398126e6067e0ac1a4afac}{QDOTMAX}}[i],\mbox{\hyperlink{utilities_8h_a7793a0ce6c398126e6067e0ac1a4afac}{QDOTMAX}}[i],\mbox{\hyperlink{safety_8cpp_a241b5a3d3b70356d48cd60e331ec48cc}{VEL\_MARGIN}},\mbox{\hyperlink{safety_8cpp_a646a293c3dcd0e785b7b2c55c3c2bf79}{CORRPOLE\_VEL}},\mbox{\hyperlink{safety_8cpp_a209f415afdd52b0876ae3cb46e04f9b2}{currentVelPole}}[i],\textcolor{keyword}{false},rdot\_i,Adiag\_i);}
\DoxyCodeLine{135         \}}
\DoxyCodeLine{136         \textcolor{comment}{// Update i-\/th element of the output vectors.}}
\DoxyCodeLine{137         rdot(i) = rdot\_i;}
\DoxyCodeLine{138         Adiag(i) = Adiag\_i;}
\DoxyCodeLine{139     \}}
\DoxyCodeLine{140 \}}

\end{DoxyCode}


\doxysubsection{Variable Documentation}
\mbox{\Hypertarget{safety_8cpp_aa7a3c54f6ce8de220877d3ecd2a860c7}\label{safety_8cpp_aa7a3c54f6ce8de220877d3ecd2a860c7}} 
\index{safety.cpp@{safety.cpp}!currentAnglePole@{currentAnglePole}}
\index{currentAnglePole@{currentAnglePole}!safety.cpp@{safety.cpp}}
\doxysubsubsection{\texorpdfstring{currentAnglePole}{currentAnglePole}}
{\footnotesize\ttfamily double current\+Angle\+Pole\mbox{[}\mbox{\hyperlink{utilities_8h_a02e7d9123cf9196d84fc399cf563e378}{N\+J\+O\+I\+N\+TS}}\mbox{]}}

Array whose i-\/th element keeps the current position correction pole for joint i if joint i is being brought back from being close to a joint limit, 0 otherwise. 

Definition at line 15 of file safety.\+cpp.

\mbox{\Hypertarget{safety_8cpp_a209f415afdd52b0876ae3cb46e04f9b2}\label{safety_8cpp_a209f415afdd52b0876ae3cb46e04f9b2}} 
\index{safety.cpp@{safety.cpp}!currentVelPole@{currentVelPole}}
\index{currentVelPole@{currentVelPole}!safety.cpp@{safety.cpp}}
\doxysubsubsection{\texorpdfstring{currentVelPole}{currentVelPole}}
{\footnotesize\ttfamily double current\+Vel\+Pole\mbox{[}\mbox{\hyperlink{utilities_8h_a02e7d9123cf9196d84fc399cf563e378}{N\+J\+O\+I\+N\+TS}}\mbox{]}}

Array whose i-\/th element keeps the current position correction pole for joint i if joint i is being slowed down because it was close to its saturation velocity, 0 otherwise. 

Definition at line 17 of file safety.\+cpp.

\mbox{\Hypertarget{safety_8cpp_a9cdf00135d8fde1d601bb55fec55a2e6}\label{safety_8cpp_a9cdf00135d8fde1d601bb55fec55a2e6}} 
\index{safety.cpp@{safety.cpp}!q@{q}}
\index{q@{q}!safety.cpp@{safety.cpp}}
\doxysubsubsection{\texorpdfstring{q}{q}}
{\footnotesize\ttfamily double q\mbox{[}\mbox{\hyperlink{utilities_8h_a02e7d9123cf9196d84fc399cf563e378}{N\+J\+O\+I\+N\+TS}}\mbox{]}}

Array of joint angle values. 

Definition at line 19 of file safety.\+cpp.

\mbox{\Hypertarget{safety_8cpp_a317c43362faf4475dce4577384fa9578}\label{safety_8cpp_a317c43362faf4475dce4577384fa9578}} 
\index{safety.cpp@{safety.cpp}!qdot@{qdot}}
\index{qdot@{qdot}!safety.cpp@{safety.cpp}}
\doxysubsubsection{\texorpdfstring{qdot}{qdot}}
{\footnotesize\ttfamily double qdot\mbox{[}\mbox{\hyperlink{utilities_8h_a02e7d9123cf9196d84fc399cf563e378}{N\+J\+O\+I\+N\+TS}}\mbox{]}}

Array of joint velocity values. 

Definition at line 21 of file safety.\+cpp.

\mbox{\Hypertarget{safety_8cpp_a36f414f3027e17561da1cc980cc683f7}\label{safety_8cpp_a36f414f3027e17561da1cc980cc683f7}} 
\index{safety.cpp@{safety.cpp}!readyq@{readyq}}
\index{readyq@{readyq}!safety.cpp@{safety.cpp}}
\doxysubsubsection{\texorpdfstring{readyq}{readyq}}
{\footnotesize\ttfamily bool readyq}

Availability flag for joint angles vector\+: true iff a valid q vector is available. 

Definition at line 11 of file safety.\+cpp.

\mbox{\Hypertarget{safety_8cpp_a264031af035928b59314f611ace3c38d}\label{safety_8cpp_a264031af035928b59314f611ace3c38d}} 
\index{safety.cpp@{safety.cpp}!readyqdot@{readyqdot}}
\index{readyqdot@{readyqdot}!safety.cpp@{safety.cpp}}
\doxysubsubsection{\texorpdfstring{readyqdot}{readyqdot}}
{\footnotesize\ttfamily bool readyqdot}

Availability flag for joint velocities vector\+: true iff a valid qdot vector is available. 

Definition at line 13 of file safety.\+cpp.

\mbox{\Hypertarget{safety_8cpp_a4ceb5170a23ad09b5f7571491ccf9da6}\label{safety_8cpp_a4ceb5170a23ad09b5f7571491ccf9da6}} 
\index{safety.cpp@{safety.cpp}!seqqdot@{seqqdot}}
\index{seqqdot@{seqqdot}!safety.cpp@{safety.cpp}}
\doxysubsubsection{\texorpdfstring{seqqdot}{seqqdot}}
{\footnotesize\ttfamily int seqqdot}



Definition at line 33 of file safety.\+cpp.

\mbox{\Hypertarget{safety_8cpp_ac9950c5982e6fa3841bc2b31e3a317b9}\label{safety_8cpp_ac9950c5982e6fa3841bc2b31e3a317b9}} 
\index{safety.cpp@{safety.cpp}!seqtry@{seqtry}}
\index{seqtry@{seqtry}!safety.cpp@{safety.cpp}}
\doxysubsubsection{\texorpdfstring{seqtry}{seqtry}}
{\footnotesize\ttfamily int seqtry}

At each step, the sequence number of the received q message, for synchronization. 

Definition at line 31 of file safety.\+cpp.

